{% extends "base.html" %}
{% block title %}
    Data Cleaning - Waskita
{% endblock title %}
{% block page_title %}
    Data Cleaning
{% endblock page_title %}
{% block breadcrumb %}
    <li class="breadcrumb-item">
        <a href="{{ url_for("dashboard") }}">Home</a>
    </li>
    <li class="breadcrumb-item active">Data Cleaning</li>
{% endblock breadcrumb %}
{% block content %}
    <!-- Main content -->
    <section class="content">
            <div class="container-fluid">
                <!-- Cleaning Statistics -->
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3>{{ raw_upload_data|length + raw_scraper_data|length }}</h3>
                                <p>Data Perlu Dibersihkan</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <h3>{{ clean_upload_data|length + clean_scraper_data|length }}</h3>
                                <p>Data Sudah Bersih</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3>{{ ((clean_upload_data|length + clean_scraper_data|length) / (raw_upload_data|length + raw_scraper_data|length + clean_upload_data|length + clean_scraper_data|length) * 100)|round(1) if (raw_upload_data|length + raw_scraper_data|length + clean_upload_data|length + clean_scraper_data|length) > 0 else 0 }}%</h3>
                                <p>Progress Cleaning</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-primary">
                            <div class="inner">
                                <h3>{{ (raw_upload_data|length + raw_scraper_data|length + clean_upload_data|length + clean_scraper_data|length) }}</h3>
                                <p>Total Data</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-database"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Cleaning Tabs -->
                <div class="card card-primary card-tabs">
                    <div class="card-header p-0 pt-1">
                        <ul class="nav nav-tabs" id="cleaningTabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active"
                                   id="raw-data-tab"
                                   data-toggle="pill"
                                   href="#raw-data"
                                   role="tab">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Data Perlu Dibersihkan
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link"
                                   id="clean-data-tab"
                                   data-toggle="pill"
                                   href="#clean-data"
                                   role="tab">
                                    <i class="fas fa-check-circle mr-2"></i>Data Sudah Bersih
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="cleaningTabsContent">
                            <!-- Data Mentah Tab -->
                            <div class="tab-pane fade show active" id="raw-data" role="tabpanel">
                                <div class="row">
                                    <!-- Raw Upload Data -->
                                    <div class="col-md-6">
                                        <div class="card card-warning">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <i class="fas fa-upload mr-2"></i>Data Upload ({{ raw_upload_data|length }})
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                {% if raw_upload_data %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Username</th>
                                                                    <th>Platform</th>
                                                                    <th>Content</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for data in raw_upload_data %}
                                                                    <tr>
                                                                        <td>{{ data.username }}</td>
                                                                        <td>
                                                                            <span class="badge bg-info">{{ data.platform }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 200px;" title="{{ data.content }}">
                                                                                {{ data.content[:50] }}{% if data.content|length > 50 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <a href="{{ url_for('clean_data', data_type='upload', data_id=data.id) }}"
                                                                               class="btn btn-sm btn-success"
                                                                               onclick="return confirm('Yakin ingin membersihkan data ini?')">
                                                                                <i class="fas fa-broom"></i> Clean
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                                        <p>Tidak ada data upload yang perlu dibersihkan</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Raw Scraper Data -->
                                    <div class="col-md-6">
                                        <div class="card card-warning">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <i class="fas fa-search mr-2"></i>Data Scraper ({{ raw_scraper_data|length }})
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                {% if raw_scraper_data %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Username</th>
                                                                    <th>Platform</th>
                                                                    <th>Keyword</th>
                                                                    <th>Content</th>
                                                                    <th>Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for data in raw_scraper_data %}
                                                                    <tr>
                                                                        <td>{{ data.username }}</td>
                                                                        <td>
                                                                            <span class="badge badge-info">{{ data.platform }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="badge bg-secondary">{{ data.keyword }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 150px;" title="{{ data.content }}">
                                                                                {{ data.content[:40] }}{% if data.content|length > 40 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <a href="{{ url_for('clean_data', data_type='scraper', data_id=data.id) }}"
                                                                               class="btn btn-sm btn-success"
                                                                               onclick="return confirm('Yakin ingin membersihkan data ini?')">
                                                                                <i class="fas fa-broom"></i> Clean
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                                        <p>Tidak ada data scraper yang perlu dibersihkan</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Clean Data Tab -->
                            <div class="tab-pane fade" id="clean-data" role="tabpanel">
                                <div class="row">
                                    <!-- Clean Upload Data -->
                                    <div class="col-md-6">
                                        <div class="card card-success">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <i class="fas fa-upload mr-2"></i>Data Upload Bersih ({{ clean_upload_data|length }})
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                {% if clean_upload_data %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Username</th>
                                                                    <th>Platform</th>
                                                                    <th>URL</th>
                                                                    <th>Original</th>
                                                                    <th>Cleaned</th>
                                                                    <th>Date</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for data in clean_upload_data %}
                                                                    <tr>
                                                                        <td>{{ data.username }}</td>
                                                                        <td>
                                                                            <span class="badge badge-info">{{ data.platform }}</span>
                                                                        </td>
                                                                        <td>
                                                                            {% if data.url %}
                                                                                <div class="text-truncate" style="max-width: 120px;" title="{{ data.url }}">
                                                                                    <a href="{{ data.url }}" target="_blank" class="text-primary">
                                                                                        {{ data.url[:25] }}{% if data.url|length > 25 %}...{% endif %}
                                                                                    </a>
                                                                                </div>
                                                                            {% else %}
                                                                                <span class="text-muted">-</span>
                                                                            {% endif %}
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 120px;" title="{{ data.content }}">
                                                                                {{ data.content[:25] }}{% if data.content|length > 25 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 120px;" title="{{ data.cleaned_content }}">
                                                                                {{ data.cleaned_content[:25] }}{% if data.cleaned_content|length > 25 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <small class="text-muted">{{ data.created_at|format_datetime('date') }}</small>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                                        <p>Belum ada data upload yang dibersihkan</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Clean Scraper Data -->
                                    <div class="col-md-6">
                                        <div class="card card-success">
                                            <div class="card-header">
                                                <h3 class="card-title">
                                                    <i class="fas fa-search mr-2"></i>Data Scraper Bersih ({{ clean_scraper_data|length }})
                                                </h3>
                                            </div>
                                            <div class="card-body">
                                                {% if clean_scraper_data %}
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-sm">
                                                            <thead>
                                                                <tr>
                                                                    <th>Username</th>
                                                                    <th>Platform</th>
                                                                    <th>Keyword</th>
                                                                    <th>Original</th>
                                                                    <th>Cleaned</th>
                                                                    <th>Date</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for data in clean_scraper_data %}
                                                                    <tr>
                                                                        <td>{{ data.username }}</td>
                                                                        <td>
                                                                            <span class="badge badge-info">{{ data.platform }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <span class="badge badge-secondary">{{ data.keyword }}</span>
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 120px;" title="{{ data.content }}">
                                                                                {{ data.content[:25] }}{% if data.content|length > 25 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <div class="text-truncate" style="max-width: 120px;" title="{{ data.cleaned_content }}">
                                                                                {{ data.cleaned_content[:25] }}{% if data.cleaned_content|length > 25 %}...{% endif %}
                                                                            </div>
                                                                        </td>
                                                                        <td>
                                                                            <small class="text-muted">{{ data.created_at|format_datetime('date') }}</small>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-inbox fa-3x mb-3"></i>
                                                        <p>Belum ada data scraper yang dibersihkan</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Actions -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-tools mr-2"></i>Bulk Actions
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-success btn-block" onclick="cleanAllData()">
                                    <i class="fas fa-broom mr-2"></i>Bersihkan Semua Data Raw
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-info btn-block" onclick="refreshData()">
                                    <i class="fas fa-sync mr-2"></i>Refresh Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    
    <!-- CSS Styling -->
    <style>
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn {
            border-radius: 10px;
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        /* Enhanced Progress Bar Styling */
        .progress {
            border-radius: 15px;
            background-color: #e9ecef;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            border-radius: 15px;
            transition: width 0.6s ease, background-color 0.3s ease;
            position: relative;
            overflow: visible;
        }
        
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            font-size: 12px;
        }
        
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        @keyframes progress-bar-stripes {
            0% {
                background-position: 1rem 0;
            }
            100% {
                background-position: 0 0;
            }
        }
        
        /* Progress info styling */
        #progressInfo {
            color: #6c757d;
            font-weight: 500;
        }
        
        #timeInfo {
            color: #495057;
            font-weight: 400;
        }
    </style>
    
    <!-- JavaScript -->
    <script>
        function cleanAllData() {
            Swal.fire({
                title: 'Konfirmasi Pembersihan',
                text: 'Yakin ingin membersihkan semua data raw? Proses ini mungkin memakan waktu lama.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Bersihkan!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading with better progress indication
                    let startTime = Date.now();
                    Swal.fire({
                        title: 'Membersihkan Data...',
                        html: `
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" style="width: 0%" id="cleaningProgress">
                                    <span class="progress-text">Memulai...</span>
                                </div>
                            </div>
                            <div class="text-center">
                                <small id="progressInfo">Mempersiapkan proses pembersihan data...</small><br>
                                <small id="timeInfo">Estimasi waktu: Menghitung...</small>
                            </div>
                        `,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            // Simulate progress animation
                            let progress = 0;
                            const progressBar = document.getElementById('cleaningProgress');
                            const progressInfo = document.getElementById('progressInfo');
                            const timeInfo = document.getElementById('timeInfo');
                            
                            const updateProgress = () => {
                                if (progress < 90) {
                                    progress += Math.random() * 10;
                                    progressBar.style.width = progress + '%';
                                    progressBar.querySelector('.progress-text').textContent = Math.round(progress) + '%';
                                    
                                    const elapsed = (Date.now() - startTime) / 1000;
                                    const estimated = elapsed / (progress / 100) - elapsed;
                                    
                                    progressInfo.textContent = `Memproses data... ${Math.round(progress)}% selesai`;
                                    timeInfo.textContent = `Waktu berlalu: ${elapsed.toFixed(1)}s | Estimasi sisa: ${estimated > 0 ? estimated.toFixed(1) + 's' : 'Hampir selesai'}`;
                                    
                                    setTimeout(updateProgress, 500 + Math.random() * 1000);
                                }
                            };
                            
                            setTimeout(updateProgress, 500);
                        }
                    });
                    
                    // Call the API
                    fetch('/api/clean/all-raw-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': $('meta[name=csrf-token]').attr('content')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Complete the progress bar
                        const progressBar = document.getElementById('cleaningProgress');
                        const progressInfo = document.getElementById('progressInfo');
                        const timeInfo = document.getElementById('timeInfo');
                        
                        if (progressBar) {
                            progressBar.style.width = '100%';
                            progressBar.querySelector('.progress-text').textContent = '100%';
                            progressBar.classList.remove('bg-primary');
                            progressBar.classList.add(data.success ? 'bg-success' : 'bg-danger');
                        }
                        
                        if (progressInfo) {
                            progressInfo.textContent = data.success ? 'Pembersihan selesai!' : 'Terjadi kesalahan!';
                        }
                        
                        if (timeInfo) {
                            const totalTime = (Date.now() - startTime) / 1000;
                            timeInfo.textContent = `Total waktu: ${totalTime.toFixed(1)} detik`;
                        }
                        
                        // Wait a moment before showing result
                        setTimeout(() => {
                        if (data.success) {
                            let message = data.message;
                            let detailMessage = `Total data yang diproses: ${data.total_data || data.processed}\n`;
                            detailMessage += `Data upload: ${data.processed_upload || 0}\n`;
                            detailMessage += `Data scraper: ${data.processed_scraper || 0}\n`;
                            detailMessage += `Waktu pemrosesan: ${data.estimated_time || 'N/A'}\n`;
                            detailMessage += `Tingkat keberhasilan: ${data.processing_rate || '100%'}`;
                            
                            if (data.errors && data.errors.length > 0) {
                                detailMessage += '\n\nPeringatan:\n' + data.errors.slice(0, 3).join('\n');
                                if (data.errors.length > 3) {
                                    detailMessage += '\n... dan ' + (data.errors.length - 3) + ' error lainnya';
                                }
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Pembersihan Selesai!',
                                html: `<div class="text-left"><strong>${message}</strong><br><br><small>${detailMessage.replace(/\n/g, '<br>')}</small></div>`,
                                confirmButtonText: 'OK',
                                width: '500px'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Gagal!',
                                text: data.message || 'Terjadi kesalahan saat membersihkan data',
                                confirmButtonText: 'OK'
                            });
                        }
                        }, 1000); // Wait 1 second to show completion
                    })
                    .catch(error => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Terjadi kesalahan jaringan. Silakan coba lagi.',
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        }
        
        function refreshData() {
            location.reload();
        }
        
        // Auto refresh every 30 seconds
        setInterval(function() {
            // Only refresh if no modal is open
            if (!$('.modal').hasClass('show')) {
                location.reload();
            }
        }, 30000);
    </script>
{% endblock content %}